@page "/charts"
@using ChartJs.Blazor.BarChart
@using ChartJs.Blazor.Common
@using ChartJs.Blazor.Common.Axes
@using ChartJs.Blazor.Common.Axes.Ticks
@using ChartJs.Blazor.BarChart.Axes
@using ChartJs.Blazor.LineChart
@using ChartJs.Blazor.Util
@using Microsoft.AspNetCore.Components.Forms
@using System.Globalization

<h3>Загрузка CSV и график</h3>

<InputFile OnChange="OnFileChange" />
<select @onchange="OnColumnSelected">
    <option disabled selected>-- Выберите столбец --</option>
    @foreach (var column in Columns)
    {
        <option value="@column">@column</option>
    }
</select>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <p style="color:red">@ErrorMessage</p>
}

@if (lineConfig != null)
{
    <div style="height:400px; overflow-x:auto; overflow-y:hidden;">
        <div style="width:800px; height:400px;">
            <Chart Config="@lineConfig" Width="@(lineConfig.Data.Labels.Count * 80)" Height="400" @key="SelectedColumn" />
        </div>
    </div>
}

@code {
    private List<string> Columns = new();
    private List<Dictionary<string, string>> CsvRows = new();
    private string SelectedColumn;
    private string ErrorMessage;
    private LineConfig lineConfig;

    protected override void OnInitialized()
    {
        
    }

    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        try
        {
            ErrorMessage = null;
            var file = e.File;
            if (file == null) { ErrorMessage = "Файл не выбран"; return; }

            using var stream = file.OpenReadStream();
            using var reader = new StreamReader(stream);

            var fileContent = await reader.ReadToEndAsync();
            var allLines = fileContent.Split(
                new[] { "\r\n", "\n", "\r" },
                StringSplitOptions.RemoveEmptyEntries);

            var headerLine = allLines.FirstOrDefault(l => l.StartsWith("02,"));
            if (headerLine == null) { ErrorMessage = "Не найдена строка с заголовками (02,)"; return; }

            Columns = headerLine.Split(',')
                .Skip(2)
                .Select(c => c.Trim())
                .Where(c => !string.IsNullOrWhiteSpace(c))
                .ToList();

            var dataLines = allLines.Where(l => l.StartsWith("80,")).ToList();
            CsvRows = dataLines.Select(l =>
            {
                var parts = l.Split(',');
                var dict = new Dictionary<string, string>();
                for (int i = 2; i < parts.Length && (i - 2) < Columns.Count; i++)
                    dict[Columns[i - 2]] = parts[i].Trim();
                return dict;
            }).ToList();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
    }

    private void OnColumnSelected(ChangeEventArgs e)
    {
        SelectedColumn = e.Value?.ToString();
        if (string.IsNullOrEmpty(SelectedColumn) || !CsvRows.Any()) return;

        try
        {
            var values = CsvRows
                .Select(r =>
                {
                    if (!r.ContainsKey(SelectedColumn)) return 0.0;
                    return double.TryParse(r[SelectedColumn],
                        NumberStyles.Any,
                        CultureInfo.InvariantCulture,
                        out var d) ? d : 0.0;
                })
                .ToList();

            if (!values.Any())
            {
                ErrorMessage = "В выбранном столбце нет числовых данных";
                return;
            }

            var minValue = values.Min();
            var maxValue = values.Max();
            var adjustedMax = maxValue + ((maxValue - minValue) / 3);

            lineConfig = new LineConfig
            {
                Options = new LineOptions
                {
                    Responsive = false,
                    MaintainAspectRatio = false,
                    Title = new OptionsTitle
                    {
                        Display = true,
                        Text = $"{SelectedColumn} (мин: {minValue:F2}, макс: {maxValue:F2})"
                    },
                    Scales = new Scales
                    {
                        YAxes = new List<CartesianAxis>
                    {
                        new LinearCartesianAxis
                        {
                            Ticks = new LinearCartesianTicks
                            {
                                BeginAtZero = false,
                                Min = minValue,
                                Max = adjustedMax
                            },
                            ScaleLabel = new ScaleLabel
                            {
                                Display = true,
                                LabelString = SelectedColumn
                            }
                        }
                    },
                        XAxes = new List<CartesianAxis>
                    {
                        new CategoryAxis
                        {
                            ScaleLabel = new ScaleLabel
                            {
                                Display = true,
                                LabelString = "Записи"
                            }
                        }
                    }
                    }
                }
            };

            var dataset = new LineDataset<double>(values)
            {
                Label = SelectedColumn,
                Fill = false,
                BorderColor = "#007bff",
                LineTension = 0.1
            };

            lineConfig.Data.Labels.Clear();
            for (int i = 1; i <= values.Count; i++)
            {
                lineConfig.Data.Labels.Add($"Запись #{i}");
            }

            lineConfig.Data.Datasets.Clear();
            lineConfig.Data.Datasets.Add(dataset);

            ErrorMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Ошибка построения графика: {ex.Message}";
        }
    }
}